<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="√âventail-AI Chat Assistant - A new way to conceive your AI interactions. Create text chats, generate images, and search the web with AI assistance.">
    <meta name="keywords" content="AI chat, ChatGPT, DALL-E, AI assistant, image generation, web search, artificial intelligence">
    <meta name="author" content="√âventail-AI">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="√âventail-AI Chat Assistant">
    <meta property="og:description" content="A new way to conceive your AI interactions with text, images, and web search capabilities.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com">
    <meta property="og:image" content="https://yourdomain.com/eventail_AI.png">
    <meta property="og:locale" content="it_IT">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="√âventail-AI Chat Assistant">
    <meta name="twitter:description" content="A new way to conceive your AI interactions">
    <meta name="twitter:image" content="https://yourdomain.com/eventail_AI.png">
    
    <title>√âventail-AI Chat Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #dc85ed;
			background: radial-gradient(circle, rgba(220, 133, 237, 1) 0%, rgba(175, 13, 219, 1) 39%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
            
        .header img {
            max-width: 350px;
            height: auto;
        }    

        h1 {
            font-size: 32px;
            color: #2c2c2c;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #222;
            font-size: 18px;
        }

        /* Prompt Area */
        .prompt-area {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        .prompt-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }
            
        .triggers {
            width: 280px;
            display: flex;
            justify-content: flex-start;
            margin: 4px;
        }
        
        .triggers span {
            font-size: 20px;     
            cursor: pointer;
            border: 1px solid transparent;
            margin-right: 4px; 
            transition: all .8s ease;    
        }    

        .triggers span:hover {
            border: 1px solid rebeccapurple;
        }    
            
        #user-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: white;
        }

        #user-input:focus {
            border-color: #6B9BD1;
            box-shadow: 0 0 0 3px rgba(107, 155, 209, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: radial-gradient(circle, rgba(220, 133, 237, 1) 0%, rgba(175, 13, 219, 1) 39%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(107, 155, 209, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #dc85ed;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #dc85ed;
        }

        /* Cards Grid */
        .cards-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            color: #222;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .cards-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 12px;
            perspective: 1000px;
            padding: 16px 20px;
            min-height: 360px;
        }

        .chat-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            padding: .5rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            height: 220px;
            width: 220px;
            display: flex;
            flex-direction: column;
            transform-origin: bottom center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 0 60px rgba(255, 255, 255, 0.3);
        }

        /* Effetto iridescente bolla di sapone */
        .chat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                linear-gradient(45deg, 
                    transparent 30%,
                    rgba(255, 0, 255, 0.2) 40%,
                    rgba(0, 255, 255, 0.2) 50%,
                    rgba(255, 255, 0, 0.2) 60%,
                    transparent 70%),
                linear-gradient(135deg,
                    rgba(255, 0, 150, 0.15) 0%,
                    rgba(0, 200, 255, 0.15) 25%,
                    rgba(150, 255, 0, 0.15) 50%,
                    rgba(255, 150, 0, 0.15) 75%,
                    rgba(255, 0, 200, 0.15) 100%);
            animation: rotate 8s linear infinite;
            opacity: 0.5;
            mix-blend-mode: screen;
            pointer-events: none;
            z-index: 1;
        }

        /* Lens flare/glare luminoso principale */
        .chat-card::after {
            content: '';
            position: absolute;
            top: 15%;
            right: 20%;
            width: 80px;
            height: 80px;
            background: radial-gradient(
                circle at center,
                rgba(255, 255, 255, 0.8) 0%,
                rgba(255, 255, 255, 0.5) 20%,
                rgba(255, 255, 255, 0.2) 40%,
                transparent 70%
            );
            border-radius: 50%;
            filter: blur(8px);
            animation: pulse-glare 3s ease-in-out infinite;
            pointer-events: none;
            mix-blend-mode: overlay;
            z-index: 1;
        }

        /* Riflesso secondario pi√π piccolo */
        .chat-card .secondary-glare {
            position: absolute;
            top: 40%;
            left: 25%;
            width: 40px;
            height: 40px;
            background: radial-gradient(
                circle at center,
                rgba(255, 255, 255, 0.6) 0%,
                rgba(255, 255, 255, 0.3) 30%,
                transparent 60%
            );
            border-radius: 50%;
            filter: blur(6px);
            animation: pulse-glare 3s ease-in-out infinite 0.5s;
            pointer-events: none;
            mix-blend-mode: overlay;
            z-index: 1;
        }

        .chat-card:hover {
            transform: rotate(0deg) translateY(-20px) scale(1.05) !important;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.2),
                inset 0 0 80px rgba(255, 255, 255, 0.4);
            border-color: #6B9BD1;
            z-index: 10;
        }

        .chat-card:hover::before {
            animation-duration: 4s;
            opacity: 0.7;
        }

        .chat-card:hover::after {
            animation-duration: 2s;
        }

        .chat-card.active {
            border-color: #6B9BD1;
            background: rgba(107, 155, 209, 0.15);
        }

        .chat-card.active::before {
            opacity: 0.6;
        }

        .chat-card.processing {
            border-color: #ffa502;
            background: rgba(255, 165, 2, 0.15);
        }

        .chat-card.processing .processing-indicator {
            content: '‚óè';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ffa502;
            font-size: 20px;
            animation: pulse 1.5s ease-in-out infinite;
            z-index: 3;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes pulse-glare {
            0%, 100% {
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
        }

        .card-title {
            font-size: 12px;
            padding: 4px;
            border-radius: 4px; 
            border: 2px solid black;    
            font-weight: 400;
            color: #000;
            background: #fff;    
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-btn {
            background: #dc85ed;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .delete-btn:hover {
            background: #e63946;
            transform: scale(1.1);
        }

        .card-preview {
            color: #000;
            font-size: 12px;
            line-height: 1.5;
            overflow: hidden;
            margin-bottom: 8px;
            flex: 1;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            position: relative;
            z-index: 2;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #000;
            position: relative;
            z-index: 2;
        }
        /* Chat Modal */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 20px;
        }

        .chat-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c2c2c;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .chat-history {
            background: radial-gradient(circle, rgba(220, 133, 237, 1) 0%, rgba(175, 13, 219, 1) 39%);    
            border-bottom: 2px solid black;    
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 90%;
            word-wrap: break-word;
        }

        .user-message {
            background: white;
            color: #222;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .chatgpt-message {
            width: 100%;
            background: #f5f5f5;
            color: #2c2c2c;
            border-bottom-left-radius: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .chatgpt-message pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-btn {
            align-self: flex-end;
            margin-top: 8px;
            background: white;
            border: 1px solid #e0e0e0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #dc85ed;
            color: white;
            border-color: #6B9BD1;
        }

        .modal-image-wrapper {
            text-align: center;
            margin-top: 12px;
        }

        .modal-image-wrapper img {
            max-width: 100%;
            border-radius: 8px;
        }

        .citations-block {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
        }

        .citations-block p {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .citations-block a {
            display: block;
            color: #007BFF;
            text-decoration: none;
            margin-bottom: 4px;
        }

        .citations-block a:hover {
            text-decoration: underline;
        }

        #typing-indicator {
            color: #999;
            font-style: italic;
            padding: 15px 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .prompt-container {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .triggers {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="eventail_AI.png" alt="√âventail-AI Logo">
            <h1>√âventail-AI Chat Assistant</h1>
            <p class="subtitle"><i>A new way to conceive your AI interactions</i></p>
        </div>

        <!-- Prompt Area -->
        <div class="prompt-area">
            <div class="prompt-container">
                <input type="text" id="user-input" placeholder="Insert your idea..." onkeypress="verifyEnter(event)">
                <button class="btn btn-primary" id="send-btn" onclick="sendMessage()">Send</button>
                <button class="btn btn-secondary" onclick="createNewTopic()">New Topic</button>
            </div>
            <div class="triggers">
                <span id="text">üìã</span>
                <span id="image">üñºÔ∏è</span>
                <span id="web">üåé</span>
                <span id="feedback">Text chat</span>
            </div>
        </div>

        <!-- Cards Section -->
        <div class="cards-section">
            <h2 class="section-title">Votre √©ventail:</h2>
            <div class="cards-grid" id="cards-container">
                <!-- Cards will be generated here -->
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Conversation card</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="chat-history" id="chat-container">
                <!-- Messages will appear here -->
            </div>
            <div class="modal-prompt" id="modal-prompt" style="display:flex; padding:20px; border-top:1px solid #e0e0e0; gap:10px;">
                <input type="text" id="modal-user-input" placeholder="Write your idea..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;" onkeypress="verifyEnterModal(event)">
                <button class="btn btn-primary" id="modal-send-btn" onclick="sendMessageFromModal()">Send</button>
            </div>    
        </div>
    </div>

<script>
// Global variables
let conversations = [];
let currentConversationId = null;
let chatMemory = [];
let apiKey = '';
let typeText = true;
let typeImage = false;
let typeWeb = false;        
const textSpan = document.getElementById('text');
const imageSpan = document.getElementById('image');        
const webSpan = document.getElementById('web');
let feedback = document.getElementById('feedback');        

// Imposta per chat testuale (default)
textSpan.style.border = "1px solid red";

textSpan.addEventListener('click', () => {
    typeText = true;
    typeImage = false;
    typeWeb = false;
    textSpan.style.border = "1px solid red";
    imageSpan.style.border = "1px solid transparent";
    webSpan.style.border = "1px solid transparent";
    feedback.innerText = 'Text chat';        
});        

imageSpan.addEventListener('click', () => {
    typeText = false;
    typeImage = true;
    typeWeb = false;
    textSpan.style.border = "1px solid transparent";
    imageSpan.style.border = "1px solid red";
    webSpan.style.border = "1px solid transparent"; 
    feedback.innerText = 'Image generation';         
}); 

webSpan.addEventListener('click', () => {
    typeText = false;
    typeImage = false;
    typeWeb = true;
    textSpan.style.border = "1px solid transparent";
    imageSpan.style.border = "1px solid transparent";
    webSpan.style.border = "1px solid red"; 
    feedback.innerText = 'Web search';         
}); 

// Initialize
async function init() {
    await loadApiKey();
    loadConversations();
}

// Load API Key from config.txt
async function loadApiKey() {
    try {
        const response = await fetch('config.txt');
        if (response.ok) {
            const text = await response.text();
            apiKey = text.trim();
            console.log('API Key caricata con successo');
        } else {
            console.error('File config.txt non trovato');
            alert('ATTENZIONE: File configurazione non trovato.');
        }
    } catch (error) {
        console.error('Errore nel caricamento della configurazione:', error);
        alert('ATTENZIONE: Impossibile caricare la configurazione. Verifica che il file esista.');
    }
}

function createMemory(messages) {
    const memory = [];
    for (const msg of messages) {
        memory.push({ role: msg.role, content: msg.content });
    }
    return memory;
}

// Load conversations from storage
async function loadConversations() {
    const loadedFromServer = await loadFromServer();
    if (!loadedFromServer) {
        const saved = localStorage.getItem('conversations');
        if (saved) {
            conversations = JSON.parse(saved);
            renderCards();
        }
    }
}

// Save conversations
function saveConversations() {
    localStorage.setItem('conversations', JSON.stringify(conversations));
    saveToServer();
}

// Save to server
async function saveToServer() {
    try {
        const response = await fetch('save-conversations.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(conversations)
        });
        const result = await response.json();
        if (result.success) {
            console.log('Conversazioni salvate sul server:', result.filename);
        } else {
            console.warn('Errore salvataggio server:', result.error);
        }
    } catch (error) {
        console.warn('Server non disponibile, salvato solo in locale:', error);
    }
}

// Load conversations from server
async function loadFromServer() {
    try {
        const response = await fetch('load-conversations.php');
        const result = await response.json();
        if (result.success && result.conversations && result.conversations.length > 0) {
            conversations = result.conversations;
            console.log('Caricate', result.count, 'conversazioni dal server');
            renderCards();
            return true;
        }
    } catch (error) {
        console.log('Nessun salvataggio trovato sul server, uso localStorage');
    }
    return false;
}

// Create new topic
function createNewTopic() {
    const newId = Date.now().toString();
    const newConversation = {
        id: newId,
        title: `Nuova Conversazione`,
        messages: [],
        chatMemory: [
            { role: 'system', content: "You are a general-knowledgebase skilled assistant who receives an input from the user and makes everything possible to find a correct answer or a valid help. You will not invent or make-up answers if you are not able to answer." }
        ],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        processing: false,
        imageUrl: null,
        type: null
    };
    conversations.unshift(newConversation);
    currentConversationId = newId;
    chatMemory = [...newConversation.chatMemory];
    saveConversations();
    renderCards();
}

// Render cards
function renderCards() {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';

    if (conversations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #000; width: 100%;">Nessuna conversazione. Inizia creando un nuovo topic!</p>';
        return;
    }

    conversations.forEach(conv => {
        const card = document.createElement('div');
        const isActive = conv.id === currentConversationId;
        const isProcessing = conv.processing || false;
        card.className = 'chat-card' +
            (isActive ? ' active' : '') +
            (isProcessing ? ' processing' : '');

        // Sfondo immagine card
        if (conv.imageUrl) {
            card.style.backgroundImage = `url(${conv.imageUrl})`;
            card.style.backgroundSize = 'cover';
            card.style.backgroundPosition = 'center';
            card.style.color = '#000';
        }

        const firstMessage = conv.messages.find(m => m.role === 'user');
        const lastMessage = conv.messages[conv.messages.length - 1];

        let preview = '';
        if (conv.type === 'image') {
            preview = 'Immagine generata';
        } else if (lastMessage && lastMessage.role === 'assistant') {
            preview = lastMessage.content.substring(0, 250);
        } else if (firstMessage) {
            preview = firstMessage.content.substring(0, 250);
        } else {
            preview = 'Nessun messaggio ancora';
        }

        const messagesCount = conv.messages.filter(m => m.role !== 'system').length;
        const date = new Date(conv.updatedAt).toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header';

        const cardTitle = document.createElement('div');
        cardTitle.className = 'card-title';
        cardTitle.textContent = conv.title;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = '√ó';
        deleteBtn.onclick = (e) => deleteConversation(conv.id, e);

        const cardPreview = document.createElement('div');
        cardPreview.className = 'card-preview';
        cardPreview.textContent = preview;

        const cardMeta = document.createElement('div');
        cardMeta.className = 'card-meta';

        const messagesSpan = document.createElement('span');
        messagesSpan.textContent = `${messagesCount} messaggi`;

        const dateSpan = document.createElement('span');
        dateSpan.textContent = date;

        cardMeta.appendChild(messagesSpan);
        cardMeta.appendChild(dateSpan);
        cardHeader.appendChild(cardTitle);
        cardHeader.appendChild(deleteBtn);
        card.appendChild(cardHeader);
        card.appendChild(cardPreview);
        card.appendChild(cardMeta);

        card.onclick = (e) => {
            if (!e.target.classList.contains('delete-btn')) {
                openModal(conv.id);
            }
        };

        container.appendChild(card);
    });

    // Effetto ventaglio ADATTIVO
    const cards = container.querySelectorAll('.chat-card');
    const total = cards.length;

    if (total === 1) {
        cards[0].style.transform = 'rotate(0deg) translateY(0px)';
    } else {
        const screenWidth = window.innerWidth;
        let maxAngle, offsetMultiplier;
        
        if (screenWidth < 768) {
            maxAngle = 5;
            offsetMultiplier = 0.5;
        } else if (screenWidth < 1024) {
            maxAngle = 8;
            offsetMultiplier = 0.7;
        } else {
            maxAngle = 10;
            offsetMultiplier = 0.8;
        }
        
        cards.forEach((card, i) => {
            const angle = ((i / (total - 1)) - 0.5) * 2 * maxAngle;
            const offsetY = Math.abs(angle) * offsetMultiplier;
            card.style.transform = `rotate(${angle}deg) translateY(${offsetY}px)`;
        });
    }
}

function deleteConversation(id, event) {
    event.stopPropagation();
    if (confirm('Eliminare questa conversazione?')) {
        conversations = conversations.filter(c => c.id !== id);
        if (currentConversationId === id) currentConversationId = null;
        saveConversations();
        renderCards();
    }
}

function openModal(conversationId) {
    currentConversationId = conversationId;
    const conversation = conversations.find(c => c.id === conversationId);
    if (!conversation) return;

    document.getElementById('modal-title').textContent = conversation.title;
    const modal = document.getElementById('chat-modal');
    const container = document.getElementById('chat-container');
    container.innerHTML = '';
    modal.classList.add('active');

    // Ripristina la memoria SPECIFICA di questa conversazione
    chatMemory = conversation.chatMemory || [
        { role: 'system', content: "You are a general-knowledgebase skilled assistant who receives an input from the user and makes everything possible to find a correct answer or a valid help. You will not invent or make-up answers if you are not able to answer." }
    ];

    // Gestione visualizzazione modal in base al tipo
    if (conversation.type === 'image') {
        document.getElementById('modal-prompt').style.display = 'none';
    } else {
        document.getElementById('modal-prompt').style.display = 'flex';
    }

    displayConversationMessages(conversation);
    renderCards();
}

function closeModal() {
    document.getElementById('chat-modal').classList.remove('active');
    document.getElementById('chat-container').innerHTML = '';
}

function escapeHTML(str) {
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function displayConversationMessages(conversation) {
    const container = document.getElementById('chat-container');
    container.innerHTML = '';

    if (conversation.type === 'image') {
        // Mostra solo prompt utente + immagine
        const userPrompt = conversation.messages.find(m => m.role === 'user');
        if (userPrompt) {
            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.textContent = userPrompt.content;
            container.appendChild(userMsg);
        }

        if (conversation.imageUrl) {
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'modal-image-wrapper';

            const img = document.createElement('img');
            img.src = conversation.imageUrl;
            img.alt = 'Immagine generata';
            imgWrapper.appendChild(img);
            container.appendChild(imgWrapper);
        }
    } else {
        // Mostra tutti i messaggi per text e web
        conversation.messages.forEach(msg => {
            if (msg.role !== 'system') {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ' +
                    (msg.role === 'user' ? 'user-message' : 'chatgpt-message');

                if (msg.role === 'assistant') {
                    if (conversation.type === 'web') {
                        // Per web: permetti HTML basilare
                        let safeHTML = msg.content
                            .replace(/\n/g, '<br>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        messageDiv.innerHTML = safeHTML;
                    } else {
                        // Per text: escapato in <pre><code>
                        const escaped = escapeHTML(msg.content);
                        messageDiv.innerHTML = `<pre style="white-space: pre-wrap; margin:0;"><code>${escaped}</code></pre>`;
                    }

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.textContent = 'Copia';
                    copyBtn.onclick = () => copyToClipboard(msg.content);
                    messageDiv.appendChild(copyBtn);

                    // Aggiungi citazioni se presenti (solo per web)
                    if (conversation.type === 'web' && msg.citations && msg.citations.length > 0) {
                        const citationsBlock = document.createElement('div');
                        citationsBlock.className = 'citations-block';
                        
                        const title = document.createElement('p');
                        title.textContent = 'Fonti:';
                        citationsBlock.appendChild(title);

                        msg.citations.forEach(c => {
                            const link = document.createElement('a');
                            link.href = c.url;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            link.textContent = c.title;
                            citationsBlock.appendChild(link);
                        });

                        messageDiv.appendChild(citationsBlock);
                    }
                } else {
                    messageDiv.textContent = msg.content;
                }

                container.appendChild(messageDiv);
            }
        });
    }
        container.scrollTop = container.scrollHeight;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert('Testo copiato!'));
}

function verifyEnter(event) {
    if (event.keyCode === 13) {
        event.preventDefault();
        sendMessage();
    }
}

function verifyEnterModal(event) {
    if (event.keyCode === 13) {
        event.preventDefault();
        sendMessageFromModal();
    }
}

async function sendMessage() {
    const inputElement = document.getElementById('user-input');
    const userInput = inputElement.value.trim();
    if (userInput === '') return;

    // Disabilita bottone durante elaborazione
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;

    if (typeText) {
        if (!currentConversationId) { createNewTopic(); }
        const conversation = conversations.find(c => c.id === currentConversationId);
        conversation.type = 'text';

        if (conversation.messages.length === 0) {
            conversation.title = userInput.substring(0, 50) + (userInput.length > 50 ? '...' : '');
        }
        
        conversation.messages.push({ role: 'user', content: userInput });
        conversation.updatedAt = new Date().toISOString();
        conversation.processing = true;
        inputElement.value = '';
        renderCards();

        await getChatGPTResponse(userInput, conversation);

        // Genera immagine SOLO se non esiste gi√†
        if (!conversation.imageUrl) {
            const imgPath = await generateCardImage(userInput);
            if (imgPath) {
                conversation.imageUrl = imgPath;
            }
        }

        conversation.processing = false;
        saveConversations();
        renderCards();

    } else if (typeImage) {
        if (!currentConversationId) { createNewTopic(); }
        const conversation = conversations.find(c => c.id === currentConversationId);
        conversation.type = 'image';

        if (conversation.messages.length === 0) {
            conversation.title = userInput.substring(0, 50) + (userInput.length > 50 ? '...' : '');
        }
        
        conversation.messages.push({ role: 'user', content: userInput });
        conversation.updatedAt = new Date().toISOString();
        conversation.processing = true;
        inputElement.value = '';
        renderCards();

        // Per image, genera SEMPRE (√® l'unico contenuto)
        const imgPath = await generateCardImage(userInput);
        if (imgPath) {
            conversation.imageUrl = imgPath;
        }

        conversation.processing = false;
        saveConversations();
        renderCards();

    } else if (typeWeb) {
        if (!currentConversationId) { createNewTopic(); }
        const conversation = conversations.find(c => c.id === currentConversationId);
        conversation.type = 'web';
        
        if (conversation.messages.length === 0) {
            conversation.title = userInput.substring(0, 50) + (userInput.length > 50 ? '...' : '');
        }
        
        conversation.messages.push({ role: 'user', content: userInput });
        conversation.updatedAt = new Date().toISOString();
        conversation.processing = true;
        inputElement.value = '';
        renderCards();
        
        await getChatGPTResponseWeb(userInput, conversation);
        
        // Genera immagine SOLO se non esiste gi√†
        if (!conversation.imageUrl) {
            const imgPath = await generateCardImage(userInput);
            if (imgPath) {
                conversation.imageUrl = imgPath;
            }
        }
        
        conversation.processing = false;
        saveConversations();
        renderCards();
    }

    // Riabilita bottone
    sendBtn.disabled = false;
}

async function sendMessageFromModal() {
    const input = document.getElementById('modal-user-input');
    const userInput = input.value.trim();
    if (userInput === '') return;
    
    const conversation = conversations.find(c => c.id === currentConversationId);
    if (!conversation) return;

    // Disabilita bottone durante elaborazione
    const modalSendBtn = document.getElementById('modal-send-btn');
    modalSendBtn.disabled = true;
    
    showMessageInModal('user', userInput);
    input.value = '';
    
    conversation.messages.push({ role: 'user', content: userInput });
    conversation.updatedAt = new Date().toISOString();
    conversation.processing = true;
    renderCards();
    
    // Chiama GPT in base al tipo (NON genera nuove immagini)
    if (conversation.type === 'web') {
        await getChatGPTResponseWeb(userInput, conversation);
    } else {
        await getChatGPTResponse(userInput, conversation);
    }
    
    conversation.processing = false;
    saveConversations();
    renderCards();

    // Riabilita bottone
    modalSendBtn.disabled = false;
}

function showMessageInModal(role, content) {
    const container = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + (role === 'user' ? 'user-message' : 'chatgpt-message');

    const conversation = conversations.find(c => c.id === currentConversationId);

    if (role === 'assistant') {
        if (conversation && conversation.type === 'web') {
            // Per web: permetti HTML basilare
            let safeHTML = content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.innerHTML = safeHTML;
        } else {
            // Per text: escapato in <pre><code>
            const escaped = escapeHTML(content);
            messageDiv.innerHTML = `<pre style="white-space: pre-wrap; margin:0;"><code>${escaped}</code></pre>`;
        }

        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'Copia';
        copyBtn.onclick = () => copyToClipboard(content);
        messageDiv.appendChild(copyBtn);
    } else {
        messageDiv.textContent = content;
    }

    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

async function getChatGPTResponse(userInput, conversation) {
    const chatContainer = document.getElementById('chat-container');
    if (!apiKey) {
        alert('API Key non configurata. Verifica il file config.txt');
        return;
    }
    
    const typingIndicator = document.createElement('p');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.textContent = 'Typing...';
    if (chatContainer) {
        chatContainer.appendChild(typingIndicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': 'Bearer ' + apiKey 
            },
            body: JSON.stringify({
                "model": "gpt-4o-mini",
                "messages": [...chatMemory, { "role": "user", "content": userInput }]
            })
        });
        
        if (typingIndicator.parentNode) typingIndicator.remove();
        
        if (!response.ok) throw new Error('Error in API request');
        
        const data = await response.json();
        const chatGPTResponse = data.choices[0].message.content.trim();
        
        let cleanResponse = chatGPTResponse.replace(/(```html|```css|```javascript|```php|```python)(.*?)/gs, '$2');
        cleanResponse = cleanResponse.replace(/```/g, "");
        
        conversation.messages.push({ role: 'assistant', content: cleanResponse });
        conversation.updatedAt = new Date().toISOString();
        
        chatMemory.push({ role: 'user', content: userInput });
        chatMemory.push({ role: 'assistant', content: cleanResponse });
        
        // Salva la memoria aggiornata nella conversazione
        conversation.chatMemory = [...chatMemory];
        
        if (document.getElementById('chat-modal').classList.contains('active')) {
            showMessageInModal('assistant', cleanResponse);
        }
    } catch (error) {
        console.error(error);
        if (typingIndicator.parentNode) typingIndicator.remove();
        alert('Errore nella comunicazione con l\'API.');
    }
}

async function generateCardImage(prompt) {
    try {
        const imgResponse = await fetch("https://api.openai.com/v1/images/generations", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "dall-e-2",
                prompt: prompt,
                size: "512x512",
                response_format: "b64_json"
            })
        });
        
        if (!imgResponse.ok) {
            console.warn("Errore generazione immagine");
            return null;
        }
        
        const data = await imgResponse.json();
        const base64 = data.data[0].b64_json;

        const saveResponse = await fetch("save-card-image.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ imageData: base64 })
        });
        
        const result = await saveResponse.json();
        if (result.success) {
            console.log("Immagine salvata:", result.filepath);
            return result.filepath;
        } else {
            console.warn("Errore salvataggio immagine:", result.error);
            return null;
        }
    } catch (err) {
        console.error("Errore generazione immagine:", err);
        return null;
    }
}

async function getChatGPTResponseWeb(userInput, conversation) {
    const chatContainer = document.getElementById('chat-container');

    if (!apiKey) {
        alert('API Key non configurata. Verifica il file config.txt');
        return;
    }

    const typingIndicator = document.createElement('p');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.textContent = 'Ricerca in corso...';
    if (chatContainer) {
        chatContainer.appendChild(typingIndicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
                model: 'gpt-4o-mini-search-preview',
                web_search_options: { search_context_size: 'medium' },
                messages: [...chatMemory, { role: 'user', content: userInput }]
            })
        });

        if (!response.ok) throw new Error('Errore durante la richiesta API.');

        const data = await response.json();
        if (typingIndicator.parentNode) typingIndicator.remove();

        const chatGPTResponse = data.choices?.[0]?.message?.content?.trim() || '';
        const annotations = data.choices?.[0]?.message?.annotations || [];
        const citations = [];

        // Estrai fonti dai riferimenti
        annotations.forEach(a => {
            if (a.type === 'url_citation' && a.url_citation?.url) {
                citations.push({
                    title: a.url_citation.title || a.url_citation.url,
                    url: a.url_citation.url
                });
            }
        });

        // Pulisci il testo
        let cleanResponse = cleanResponseText(chatGPTResponse, annotations);

        // Aggiorna la conversazione
        conversation.messages.push({
            role: 'assistant',
            content: cleanResponse,
            citations: citations
        });
        conversation.updatedAt = new Date().toISOString();
        
        chatMemory.push({ role: 'user', content: userInput });
        chatMemory.push({ role: 'assistant', content: cleanResponse });
        
        // Salva la memoria aggiornata nella conversazione
        conversation.chatMemory = [...chatMemory];

        // Mostra nel modale se aperto
        if (document.getElementById('chat-modal').classList.contains('active')) {
            showMessageInModal('assistant', cleanResponse);
            if (citations.length > 0) {
                appendCitationsToModal(citations);
            }
        }

        conversation.processing = false;
        saveConversations();
        renderCards();

    } catch (error) {
        console.error(error);
        if (typingIndicator.parentNode) typingIndicator.remove();
        alert('Errore nella comunicazione con l\'API Web.');
    }
}

function cleanResponseText(response, citations) {
    const citationUrls = citations
        .filter(a => a.type === 'url_citation' && a.url_citation?.url)
        .map(a => a.url_citation.url);

    let cleaned = response;
    citationUrls.forEach(url => {
        const urlRegex = new RegExp(url.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        cleaned = cleaned.replace(urlRegex, '');
    });

    cleaned = cleaned
        .replace(/https?:\/\/[^\s]+/g, '')
        .replace(/[ ]{2,}/g, ' ')
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .trim();

    return cleaned;
}

function appendCitationsToModal(citations) {
    const container = document.getElementById('chat-container');
    if (!container) return;

    const block = document.createElement('div');
    block.className = 'citations-block';

    const title = document.createElement('p');
    title.textContent = 'Fonti:';
    block.appendChild(title);

    citations.forEach(c => {
        const link = document.createElement('a');
        link.href = c.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = c.title;
        block.appendChild(link);
    });

    container.appendChild(block);
    container.scrollTop = container.scrollHeight;
}

// Ricalcola ventaglio al resize
let resizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        renderCards();
    }, 250);
});

window.onload = init;
</script>
</body>
</html>